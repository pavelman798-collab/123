;=================================================================
; Dialplan для телефонных кампаний через GoIP-4
;=================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; IP адреса (обновляется автоматически при запуске)
GOIP_IP=192.168.8.1
ASTERISK_IP=192.168.8.100

;=================================================================
; Контекст для входящих звонков от GoIP (для тестирования)
;=================================================================
[from-goip]
exten => _X.,1,NoOp(=== Входящий тестовый звонок от GoIP ===)
 same => n,NoOp(Caller: ${CALLERID(num)}, Endpoint: ${CHANNEL(endpoint)})
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(hello-world)
 same => n,Hangup()

;=================================================================
; Контекст для исходящих звонков (используется campaign_manager.py)
;=================================================================
[outbound-calls]

; Исходящий звонок через указанную линию GoIP
; Формат: Dial(Local/${NUMBER}@outbound-calls,1,line${LINE_NUM})
exten => _7XXXXXXXXXX,1,NoOp(=== Исходящий звонок на ${EXTEN} ===)
 same => n,Set(LINE=${ARG1})  ; Номер линии передается как аргумент
 same => n,GotoIf($["${LINE}" = ""]?autoselect:dial)

 ; Автовыбор линии (если не указана)
 same => n(autoselect),Set(LINE=2)  ; По умолчанию используем Line 2

 ; Совершаем звонок через выбранную линию
 same => n(dial),NoOp(Использую GoIP Line ${LINE})
 same => n,Dial(PJSIP/${EXTEN}@goip-line${LINE},60,g)
 same => n,NoOp(Статус: ${DIALSTATUS})
 same => n,Hangup()

;=================================================================
; Тестовые звонки (для проверки работы GoIP)
;=================================================================
[test-calls]

; Тест GoIP Line 2 (активная SIM)
exten => 100,1,NoOp(=== Тест исходящего звонка через Line 2 ===)
 same => n,Answer()
 same => n,Playback(demo-congrats)
 same => n,Dial(PJSIP/79991234567@goip-line2,30)
 same => n,Playback(demo-thanks)
 same => n,Hangup()
