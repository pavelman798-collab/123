;=================================================================
; Dialplan для исходящих звонков через GoIP-4
;=================================================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; Операторы по первым цифрам номера (примерные диапазоны)
MTS_PREFIXES=910,911,912,913,914,915,916,917,918,919,980,981,982,983,984,985,986,987,988,989
BEELINE_PREFIXES=903,905,906,909,951,952,953,960,961,962,963,964,965,966,967,968,969
MEGAFON_PREFIXES=920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,936,937,938,939
TELE2_PREFIXES=900,901,902,904,908,950,951,952,953,954,955,958,977,991,992,993,994,995

;=================================================================
; Контекст для исходящих звонков
;=================================================================
[outbound-calls]

; AGI скрипт для умного выбора SIM-карты
exten => _7XXXXXXXXXX,1,NoOp(=== Исходящий звонок на ${EXTEN} ===)
same => n,AGI(select_sim.py,${EXTEN})  ; Скрипт выбирает SIM
same => n,NoOp(Выбрана SIM: ${SIM_ID}, Оператор: ${OPERATOR})
same => n,GotoIf($["${SIM_ID}" = ""]?hangup)
same => n,Dial(PJSIP/${EXTEN}@goip-sim${SIM_ID},60,g)
same => n,NoOp(Статус звонка: ${DIALSTATUS})
same => n,Hangup()
same => n(hangup),NoOp(Нет доступных SIM-карт)
same => n,Hangup()

; Проигрывание аудиофайла
exten => _7XXXXXXXXXX,1,NoOp(=== Звонок с проигрыванием аудио ===)
same => n,AGI(select_sim.py,${EXTEN})
same => n,Dial(PJSIP/${EXTEN}@goip-sim${SIM_ID},60,g)
same => n,GotoIf($["${DIALSTATUS}" = "ANSWER"]?play)
same => n,Hangup()
same => n(play),Playback(/audio/${AUDIO_FILE})
same => n,Wait(1)
same => n,Hangup()

;=================================================================
; Ручной выбор SIM (для тестирования)
;=================================================================
[test-calls]

; Тест через SIM1 (МТС)
exten => _1XXXXXXXXXX,1,NoOp(=== Тест SIM1 (МТС) ===)
same => n,Dial(PJSIP/${EXTEN:1}@goip-sim1,60)
same => n,Hangup()

; Тест через SIM2 (Билайн)
exten => _2XXXXXXXXXX,1,NoOp(=== Тест SIM2 (Билайн) ===)
same => n,Dial(PJSIP/${EXTEN:1}@goip-sim2,60)
same => n,Hangup()

; Тест через SIM3 (Мегафон)
exten => _3XXXXXXXXXX,1,NoOp(=== Тест SIM3 (Мегафон) ===)
same => n,Dial(PJSIP/${EXTEN:1}@goip-sim3,60)
same => n,Hangup()

; Тест через SIM4 (Теле2)
exten => _4XXXXXXXXXX,1,NoOp(=== Тест SIM4 (Теле2) ===)
same => n,Dial(PJSIP/${EXTEN:1}@goip-sim4,60)
same => n,Hangup()
