services:
  # Asterisk PBX для работы с GoIP-4
  asterisk:
    build: ./docker/asterisk
    container_name: phone-asterisk
    restart: unless-stopped
    ports:
      - "5060:5060/udp"    # SIP
      - "5060:5060/tcp"    # SIP TCP
      - "10000-10099:10000-10099/udp"  # RTP (аудио)
      - "5038:5038"        # AMI (Asterisk Manager Interface)
    volumes:
      - ./docker/asterisk/etc:/etc/asterisk
      - ./docker/asterisk/sounds:/var/lib/asterisk/sounds/custom
      - ./docker/asterisk/agi:/var/lib/asterisk/agi-bin
      - ./logs:/var/log/asterisk
      - ./audio:/audio
    networks:
      - phone-network
    environment:
      - TZ=Europe/Moscow

  # PostgreSQL для хранения данных кампаний
  postgres:
    image: postgres:15-alpine
    container_name: phone-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: phone_campaigns
      POSTGRES_USER: phone_user
      POSTGRES_PASSWORD: phone_pass_2024
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - phone-network

  # Campaign Manager - Python сервис для управления
  campaign-manager:
    build: ./docker/scripts
    container_name: phone-campaign-manager
    restart: unless-stopped
    depends_on:
      - asterisk
      - postgres
    ports:
      - "8000:8000"  # API для управления
    volumes:
      - ./docker/scripts:/app
      - ./audio:/audio
      - ./logs:/logs
    networks:
      - phone-network
    environment:
      - DATABASE_URL=postgresql://phone_user:phone_pass_2024@postgres:5432/phone_campaigns
      - ASTERISK_HOST=asterisk
      - ASTERISK_AMI_PORT=5038
      - ASTERISK_AMI_USER=admin
      - ASTERISK_AMI_SECRET=asterisk_secret
      - TZ=Europe/Moscow

networks:
  phone-network:
    driver: bridge

volumes:
  postgres-data:
